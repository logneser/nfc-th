<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multikonwerter RFID</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; padding: 20px; background: #eceff1; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 500px; margin: auto; }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 0.9em; color: #555; }
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .row div { flex: 1; }
        input { width: 100%; padding: 12px; margin-top: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.1em; box-sizing: border-box; font-family: monospace; }
        input:focus { border-color: #4CAF50; outline: none; background: #f9fff9; }
        input[readonly] { background-color: #f8f9fa; border-color: #eee; color: #666; cursor: default; }
        
        .btn-nfc { width: 100%; padding: 15px; margin-top: 20px; background-color: #2196F3; color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; }
        .btn-nfc.active { background-color: #f44336; }
        .btn-reset { width: 100%; padding: 12px; margin-top: 15px; background-color: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-xlsx { width: 100%; padding: 12px; margin-top: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: none; }
        
        #status { font-size: 0.85em; text-align: center; margin-top: 12px; color: #d35400; font-weight: bold; min-height: 1.5em; }
        
        .table-res { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.75em; }
        .table-res th, .table-res td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .table-res th { background: #f2f2f2; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; margin-top:0; color: #2c3e50;">Konwerter RFID (40-bit)</h2>

    <button id="scanButton" class="btn-nfc">START SKANOWANIA</button>
    <div id="status">Gotowy do skanowania</div>

    <label>Seryjny (HEX)</label>
    <input type="text" id="serial" placeholder="np. 4B:27:91:16:00" oninput="handleSerial(this.value)">

    <label>Format TH (Oryginał | Alternatywa)</label>
    <div class="row">
        <div><input type="text" id="th" placeholder="TH HEX..." oninput="handleTH(this.value)"></div>
        <div><input type="text" id="th_alt" readonly></div>
    </div>

    <label>Format Green (FC-ID)</label>
    <input type="text" id="green" placeholder="np. 00358-300069" oninput="handleGreen(this.value)">

    <table class="table-res" id="cardTable">
        <thead>
            <tr>
                <th>Lp</th>
                <th>Seryjny</th>
                <th>TH</th>
                <th>Green</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button id="downloadBtn" class="btn-xlsx">POBIERZ .XLSX</button>
    <button class="btn-reset" onclick="resetAll()">WYCZYŚĆ WSZYSTKO</button>
</div>

<script>
    let scannedData = [];
    let isScanning = false;
    let nfcAbortController = null;

    const scanButton = document.getElementById('scanButton');
    const status = document.getElementById('status');

    scanButton.addEventListener('click', async () => {
        if (isScanning) { 
            stopNfcScan();
            return; 
        }

        if (!('NDEFReader' in window)) {
            status.innerText = "BŁĄD: Brak obsługi NFC.";
            return;
        }

        try {
            nfcAbortController = new AbortController();
            const ndef = new NDEFReader();
            
            await ndef.scan({ signal: nfcAbortController.signal });
            
            isScanning = true;
            scanButton.innerText = "ZATRZYMAJ SKANOWANIE";
            scanButton.classList.add('active');
            status.innerText = "Skanowanie aktywne... Zbliżaj karty.";

            ndef.onreading = ({ serialNumber }) => {
                handleSerial(serialNumber);
                const currentTh = document.getElementById('th').value;
                const isDuplicate = scannedData.some(card => card.TH === currentTh);
                
                if (!isDuplicate) {
                    saveToTable();
                    status.innerText = "Zeskanowano nowy UID: " + serialNumber;
                    if (navigator.vibrate) navigator.vibrate(100);
                } else {
                    status.innerText = "Karta już jest na liście!";
                    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                }
            };
        } catch (error) {
            if (error.name !== "AbortError") {
                status.innerText = "Błąd: " + error.message;
                stopNfcScan();
            }
        }
    });

    function stopNfcScan() {
        if (nfcAbortController) {
            nfcAbortController.abort();
            nfcAbortController = null;
        }
        isScanning = false;
        scanButton.innerText = "START SKANOWANIA";
        scanButton.classList.remove('active');
        status.innerText = "Skanowanie zatrzymane. Lista zachowana.";
    }

    function bitCount(n) { return BigInt(n).toString(2).split('1').length - 1; }

    function updateAll(mainThHex, fc, cid, source) {
        mainThHex = mainThHex.toUpperCase().padStart(10, '0');
        if (source !== 'th') document.getElementById('th').value = mainThHex;
        let val = BigInt("0x" + mainThHex);
        document.getElementById('th_alt').value = (val ^ 1n).toString(16).toUpperCase().padStart(10, '0');
        if (source !== 'green') document.getElementById('green').value = `${String(fc).padStart(5, '0')}-${String(cid).padStart(6, '0')}`;
        if (source !== 'serial') {
            let bytes = [];
            for (let i = 0; i < 10; i += 2) { bytes.push(mainThHex.substr(i, 2)); }
            document.getElementById('serial').value = bytes.reverse().join(':').toUpperCase();
        }
    }

    function handleGreen(val) {
        let parts = val.split('-');
        if (parts.length === 2 && parts[0] !== "" && parts[1] !== "") {
            let fc = BigInt(parts[0]);
            let id_ = BigInt(parts[1]);
            let val_39 = (fc << 19n) | id_;
            let ones = bitCount(val_39);
            let pb_even = (ones % 2 === 0) ? 0n : 1n;
            let th_even = ((val_39 << 1n) | pb_even).toString(16).toUpperCase().padStart(10, '0');
            updateAll(th_even, fc, id_, 'green');
            document.getElementById('green').value = val;
        }
    }

    function handleTH(val) {
        let clean = val.replace(/[^0-9A-Fa-f]/g, '');
        if (clean.length > 0) {
            let thVal = BigInt("0x" + clean);
            let fc = thVal >> 20n;
            let id_ = (thVal >> 1n) & 0x7FFFFn;
            updateAll(clean, fc, id_, 'th');
        }
    }

    function handleSerial(val) {
        let clean = val.replace(/[^0-9A-Fa-f]/g, '');
        if (clean.length >= 8) {
            let bytes = [];
            if (clean.length % 2 !== 0) clean = '0' + clean;
            for (let i = 0; i < clean.length; i += 2) { bytes.push(clean.substr(i, 2)); }
            let thHex = bytes.reverse().join('').padStart(10, '0');
            let thVal = BigInt("0x" + thHex);
            let fc = thVal >> 20n;
            let id_ = (thVal >> 1n) & 0x7FFFFn;
            updateAll(thHex, fc, id_, 'serial');
            document.getElementById('serial').value = val.toUpperCase();
        }
    }

    function saveToTable() {
        const serial = document.getElementById('serial').value;
        const th = document.getElementById('th').value;
        const thAlt = document.getElementById('th_alt').value;
        const green = document.getElementById('green').value;
        
        scannedData.push({
            "Lp": scannedData.length + 1,
            "Seryjny": serial,
            "TH": th,
            "TH Alt": thAlt,
            "Green": green
        });

        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow(0);
        row.insertCell(0).innerText = scannedData.length;
        row.insertCell(1).innerText = serial;
        row.insertCell(2).innerText = th;
        row.insertCell(3).innerText = green;
        
        document.getElementById('downloadBtn').style.display = 'block';
    }

    document.getElementById('downloadBtn').addEventListener('click', () => {
        const ws = XLSX.utils.json_to_sheet(scannedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Lista Kart");
        XLSX.writeFile(wb, "skan_rfid_lista.xlsx");
    });

    function resetAll() {
        if(confirm("Czy na pewno wyczyścić wszystko i zresetować formularz?")) {
            location.reload();
        }
    }
</script>

</body>
</html>
